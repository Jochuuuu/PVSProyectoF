name: OWASP CSP Validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  owasp-csp-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
    
    - name: üìã Extraer y validar CSP
      run: |
        echo "============================================"
        echo "üöÄ VALIDACI√ìN LOCAL OWASP CSP"
        echo "============================================"
        echo ""
        
        # Buscar archivo HTML (main.html o index.html)
        if [ -f "main.html" ]; then
          HTML_FILE="main.html"
        elif [ -f "index.html" ]; then
          HTML_FILE="index.html"
        else
          echo "‚ùå ERROR: No se encontr√≥ main.html ni index.html"
          exit 1
        fi
        
        echo "üìÑ Analizando: $HTML_FILE"
        
        # Extraer CSP (maneja m√∫ltiples l√≠neas)
        CSP=$(cat "$HTML_FILE" | tr '\n' ' ' | grep -o 'Content-Security-Policy[^"]*' | head -1)
        
        if [ -z "$CSP" ]; then
          echo "‚ùå ERROR: No se encontr√≥ Content-Security-Policy en $HTML_FILE"
          exit 1
        fi
        
        echo "‚úÖ CSP encontrado"
        echo ""
        echo "üìã Tu CSP actual:"
        echo "$CSP" | fold -w 80
        echo ""
        echo ""
        
        # ============================================
        # OWASP A03:2021 - Injection (XSS)
        # ============================================
        echo "============================================"
        echo "üõ°Ô∏è  OWASP Top 10 - A03:2021 Injection (XSS)"
        echo "============================================"
        
        # Validar unsafe-inline en script-src
        if echo "$CSP" | grep -i "script-src" | grep -q "unsafe-inline"; then
          echo "‚ùå CR√çTICO: script-src contiene 'unsafe-inline'"
          echo "   üìå Vulnerabilidad: Permite inyecci√≥n de scripts (XSS)"
          echo "   üîó OWASP: https://owasp.org/Top10/A03_2021-Injection/"
          exit 1
        fi
        echo "‚úÖ script-src NO tiene 'unsafe-inline'"
        
        # Validar unsafe-eval
        if echo "$CSP" | grep -q "unsafe-eval"; then
          echo "‚ùå CR√çTICO: CSP contiene 'unsafe-eval'"
          echo "   üìå Vulnerabilidad: Permite eval() (XSS)"
          exit 1
        fi
        echo "‚úÖ CSP NO tiene 'unsafe-eval'"
        
        # Validar hashes SHA-256
        if echo "$CSP" | grep -q "sha256-"; then
          HASH_COUNT=$(echo "$CSP" | grep -o "sha256-[A-Za-z0-9+/=]*" | wc -l)
          echo "‚úÖ CSP usa hashes SHA-256 (encontrados: $HASH_COUNT)"
        else
          echo "‚ùå ERROR: CSP no usa hashes SHA-256"
          echo "   üìå Debe usar hashes en lugar de 'self' o 'unsafe-inline'"
          exit 1
        fi
        
        echo ""
        
        # ============================================
        # OWASP A04:2021 - Insecure Design
        # ============================================
        echo "============================================"
        echo "üõ°Ô∏è  OWASP Top 10 - A04:2021 Insecure Design"
        echo "============================================"
        
        if echo "$CSP" | grep -q "frame-ancestors.*'none'"; then
          echo "‚úÖ frame-ancestors 'none' configurado"
          echo "   üìå Protecci√≥n contra Clickjacking activa"
        elif echo "$CSP" | grep -q "frame-ancestors.*'self'"; then
          echo "‚ö†Ô∏è  WARNING: frame-ancestors solo permite 'self'"
          echo "   üí° Recomendaci√≥n: usar 'none' para m√°xima seguridad"
        else
          echo "‚ùå ERROR: frame-ancestors no est√° configurado"
          echo "   üìå Vulnerable a ataques de Clickjacking"
          exit 1
        fi
        
        echo ""
        
        # ============================================
        # OWASP A05:2021 - Security Misconfiguration
        # ============================================
        echo "============================================"
        echo "üõ°Ô∏è  OWASP Top 10 - A05:2021 Security Misconfiguration"
        echo "============================================"
        
        # Validar default-src
        if echo "$CSP" | grep -q "default-src.*'self'"; then
          echo "‚úÖ default-src 'self' configurado (restrictivo)"
        else
          echo "‚ö†Ô∏è  WARNING: default-src deber√≠a ser 'self'"
        fi
        
        # Validar base-uri
        if echo "$CSP" | grep -q "base-uri"; then
          echo "‚úÖ base-uri configurado"
        else
          echo "‚ö†Ô∏è  WARNING: base-uri no configurado (recomendado: 'self')"
        fi
        
        # Validar form-action
        if echo "$CSP" | grep -q "form-action"; then
          echo "‚úÖ form-action configurado"
        else
          echo "‚ö†Ô∏è  WARNING: form-action no configurado (recomendado: 'self')"
        fi
        
        echo ""
        echo "================================================"
        echo "üéâ VALIDACI√ìN OWASP CSP COMPLETADA EXITOSAMENTE"
        echo "================================================"
        echo ""
        echo "‚úÖ A03:2021 - Injection (XSS)           : PROTEGIDO"
        echo "‚úÖ A04:2021 - Insecure Design          : PROTEGIDO"  
        echo "‚úÖ A05:2021 - Security Misconfiguration: PROTEGIDO"
        echo ""
        echo "üîí Tu aplicaci√≥n cumple con OWASP Top 10 2021"
        echo "üèÜ CSP Nivel: M√ÅXIMO"
        echo ""