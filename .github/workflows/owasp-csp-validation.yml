name: OWASP CSP Validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  owasp-csp-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸš€ Iniciar servidor HTTP
      run: |
        python3 -m http.server 8080 &
        sleep 3
        echo "âœ… Servidor iniciado en http://localhost:8080"
    
    - name: ğŸ“‹ Obtener CSP del HTML
      id: get-csp
      run: |
        echo "Analizando main.html..."
        CSP=$(grep -i "Content-Security-Policy" main.html || echo "")
        
        if [ -z "$CSP" ]; then
          echo "âŒ ERROR: No se encontrÃ³ Content-Security-Policy"
          exit 1
        fi
        
        echo "âœ… CSP encontrado"
        echo "$CSP"
    
    - name: ğŸ” OWASP A03:2021 - Validar protecciÃ³n XSS
      run: |
        echo "============================================"
        echo "ğŸ›¡ï¸  OWASP Top 10 - A03:2021 Injection (XSS)"
        echo "============================================"
        
        CSP=$(grep -i "Content-Security-Policy" main.html)
        
        # Validar unsafe-inline en script-src
        if echo "$CSP" | grep -i "script-src" | grep -q "unsafe-inline"; then
          echo "âŒ CRÃTICO: script-src contiene 'unsafe-inline'"
          echo "   ğŸ“Œ Vulnerabilidad: Permite inyecciÃ³n de scripts (XSS)"
          echo "   ğŸ”— OWASP: https://owasp.org/Top10/A03_2021-Injection/"
          exit 1
        fi
        echo "âœ… script-src NO tiene 'unsafe-inline'"
        
        # Validar unsafe-eval
        if echo "$CSP" | grep -q "unsafe-eval"; then
          echo "âŒ CRÃTICO: CSP contiene 'unsafe-eval'"
          echo "   ğŸ“Œ Vulnerabilidad: Permite eval() (XSS)"
          exit 1
        fi
        echo "âœ… CSP NO tiene 'unsafe-eval'"
        
        # Validar hashes SHA-256
        if echo "$CSP" | grep -q "sha256-"; then
          echo "âœ… CSP usa hashes SHA-256 (OWASP recomendado)"
        else
          echo "âŒ ERROR: CSP no usa hashes SHA-256"
          exit 1
        fi
    
    - name: ğŸ” OWASP A04:2021 - Validar Clickjacking
      run: |
        echo ""
        echo "============================================"
        echo "ğŸ›¡ï¸  OWASP Top 10 - A04:2021 Insecure Design"
        echo "============================================"
        
        CSP=$(grep -i "Content-Security-Policy" main.html)
        
        if echo "$CSP" | grep -q "frame-ancestors.*'none'"; then
          echo "âœ… frame-ancestors 'none' configurado"
          echo "   ğŸ“Œ ProtecciÃ³n contra Clickjacking activa"
        else
          echo "âŒ ERROR: frame-ancestors no estÃ¡ configurado"
          exit 1
        fi
    
    - name: ğŸ” OWASP A05:2021 - Validar ConfiguraciÃ³n Segura
      run: |
        echo ""
        echo "============================================"
        echo "ğŸ›¡ï¸  OWASP Top 10 - A05:2021 Security Misconfiguration"
        echo "============================================"
        
        CSP=$(grep -i "Content-Security-Policy" main.html)
        
        # Validar default-src
        if echo "$CSP" | grep -q "default-src.*'self'"; then
          echo "âœ… default-src 'self' configurado (restrictivo)"
        else
          echo "âš ï¸  WARNING: default-src deberÃ­a ser 'self'"
        fi
        
        # Validar base-uri
        if echo "$CSP" | grep -q "base-uri"; then
          echo "âœ… base-uri configurado"
        else
          echo "âš ï¸  WARNING: base-uri no configurado"
        fi
        
        # Validar form-action
        if echo "$CSP" | grep -q "form-action"; then
          echo "âœ… form-action configurado"
        else
          echo "âš ï¸  WARNING: form-action no configurado"
        fi
    
    - name: ğŸ‰ Resumen de ValidaciÃ³n OWASP
      run: |
        echo ""
        echo "================================================"
        echo "ğŸ‰ VALIDACIÃ“N OWASP CSP COMPLETADA EXITOSAMENTE"
        echo "================================================"
        echo ""
        echo "âœ… A03:2021 - Injection (XSS)           : PROTEGIDO"
        echo "âœ… A04:2021 - Insecure Design          : PROTEGIDO"
        echo "âœ… A05:2021 - Security Misconfiguration: PROTEGIDO"
        echo ""
        echo "ğŸ”’ Tu aplicaciÃ³n cumple con OWASP Top 10 2021"
        echo "ğŸ† CSP Nivel: MÃXIMO"
        echo ""