name: OWASP CSP Validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  owasp-csp-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
    
    - name: Validación de Content Security Policy
      run: |
        # Redirigir toda la salida a un archivo
        exec > >(tee csp-validation-report.txt)
        exec 2>&1
        
        echo "============================================"
        echo "VALIDACION OWASP - CONTENT SECURITY POLICY"
        echo "============================================"
        echo ""
        
        # Buscar archivo HTML
        if [ -f "main.html" ]; then
          HTML_FILE="main.html"
        elif [ -f "index.html" ]; then
          HTML_FILE="index.html"
        else
          echo "ERROR: No se encontro main.html ni index.html"
          exit 1
        fi
        
        echo "Analizando archivo: $HTML_FILE"
        
        # Extraer CSP del meta tag
        CSP=$(grep -Pzo '(?s)<meta[^>]*Content-Security-Policy[^>]*content="[^"]*"' "$HTML_FILE" | tr -d '\0' | grep -o 'content="[^"]*"' | sed 's/content="//;s/"$//' | tr '\n' ' ')
        
        if [ -z "$CSP" ]; then
          echo "No se encontro Content-Security-Policy, intentando metodo alternativo..."
          CSP=$(sed -n '/<meta.*Content-Security-Policy/,/>/p' "$HTML_FILE" | tr '\n' ' ' | grep -o 'content="[^"]*"' | sed 's/content="//;s/"$//')
        fi
        
        if [ -z "$CSP" ]; then
          echo "ERROR: No se pudo extraer el CSP del documento"
          exit 1
        fi
        
        echo "Content Security Policy encontrado correctamente"
        echo ""
        echo "CSP configurado:"
        echo "$CSP" | fold -w 80
        echo ""
        
        # ============================================
        # OWASP A03:2021 - Injection (XSS)
        # ============================================
        echo "============================================"
        echo "OWASP A03:2021 - Injection"
        echo "Validando proteccion contra Cross-Site Scripting (XSS)"
        echo "============================================"
        
        # Extraer SOLO la directiva script-src
        SCRIPT_SRC=$(echo "$CSP" | grep -o "script-src[^;]*")
        
        # Validar unsafe-inline en script-src
        if echo "$SCRIPT_SRC" | grep -q "unsafe-inline"; then
          echo "FALLO CRITICO: script-src contiene 'unsafe-inline'"
          echo "Vulnerabilidad: Permite inyeccion de scripts arbitrarios"
          echo "Referencia: https://owasp.org/Top10/A03_2021-Injection/"
          echo ""
          echo "script-src detectado:"
          echo "$SCRIPT_SRC"
          exit 1
        fi
        echo "[PASS] script-src no contiene 'unsafe-inline'"
        
        # Validar unsafe-eval
        if echo "$CSP" | grep -q "unsafe-eval"; then
          echo "FALLO CRITICO: CSP contiene 'unsafe-eval'"
          echo "Vulnerabilidad: Permite ejecucion dinamica de codigo"
          exit 1
        fi
        echo "[PASS] CSP no contiene 'unsafe-eval'"
        
        # Validar hashes SHA-256
        if echo "$CSP" | grep -q "sha256-"; then
          HASH_COUNT=$(echo "$CSP" | grep -o "sha256-[A-Za-z0-9+/=]*" | wc -l)
          echo "[PASS] CSP implementa integridad con hashes SHA-256"
          echo "       Total de hashes encontrados: $HASH_COUNT"
          echo ""
          echo "       Hashes configurados:"
          echo "$CSP" | grep -o "sha256-[A-Za-z0-9+/=]*" | while read hash; do
            echo "       * $hash"
          done
        else
          echo "FALLO: CSP no implementa hashes SHA-256"
          echo "Requerimiento: Usar hashes en lugar de 'self' o 'unsafe-inline'"
          echo ""
          echo "CSP actual:"
          echo "$CSP"
          exit 1
        fi
        
        echo ""
        
        # ============================================
        # OWASP A04:2021 - Insecure Design
        # ============================================
        echo "============================================"
        echo "OWASP A04:2021 - Insecure Design"
        echo "Validando proteccion contra Clickjacking"
        echo "============================================"
        
        if echo "$CSP" | grep -q "frame-ancestors.*'none'"; then
          echo "[PASS] frame-ancestors configurado como 'none'"
          echo "       Proteccion contra Clickjacking activa"
        elif echo "$CSP" | grep -q "frame-ancestors.*'self'"; then
          echo "[WARN] frame-ancestors configurado como 'self'"
          echo "       Recomendacion: usar 'none' para maxima seguridad"
        else
          echo "FALLO: frame-ancestors no esta configurado"
          echo "Vulnerabilidad: Susceptible a ataques de Clickjacking"
          exit 1
        fi
        
        echo ""
        
        # ============================================
        # OWASP A05:2021 - Security Misconfiguration
        # ============================================
        echo "============================================"
        echo "OWASP A05:2021 - Security Misconfiguration"
        echo "Validando configuracion segura del CSP"
        echo "============================================"
        
        # Validar default-src
        if echo "$CSP" | grep -q "default-src.*'self'"; then
          echo "[PASS] default-src configurado de forma restrictiva ('self')"
        else
          echo "[WARN] default-src deberia estar configurado como 'self'"
        fi
        
        # Validar base-uri
        if echo "$CSP" | grep -q "base-uri"; then
          echo "[PASS] base-uri esta configurado"
        else
          echo "[WARN] base-uri no configurado (recomendado: 'self')"
        fi
        
        # Validar form-action
        if echo "$CSP" | grep -q "form-action"; then
          echo "[PASS] form-action esta configurado"
        else
          echo "[WARN] form-action no configurado (recomendado: 'self')"
        fi
        
        echo ""
        echo "================================================"
        echo "RESULTADO: VALIDACION COMPLETADA EXITOSAMENTE"
        echo "================================================"
        echo ""
        echo "Resumen de cumplimiento OWASP Top 10 2021:"
        echo ""
        echo "  [PASS] A03:2021 - Injection (XSS)"
        echo "  [PASS] A04:2021 - Insecure Design (Clickjacking)"  
        echo "  [PASS] A05:2021 - Security Misconfiguration"
        echo ""
        echo "Estado: APROBADO"
        echo "Nivel de seguridad CSP: MAXIMO"
        echo ""
        echo "============================================"
        echo "Reporte generado: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "============================================"
    
    - name: Upload CSP Validation Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: csp-validation-report
        path: csp-validation-report.txt
